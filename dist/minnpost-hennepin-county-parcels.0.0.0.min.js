/*! minnpost-hennepin-county-parcels - v0.0.0 - 2014-05-04
* https://github.com/minnpost/minnpost-hennepin-county-parcels
* Copyright (c) 2014 MinnPost; Licensed MIT */

L.Util.ajax=function(url,cb){void 0===window.XMLHttpRequest&&(window.XMLHttpRequest=function(){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(a){throw new Error("XMLHttpRequest is not supported")}});var response,request=new XMLHttpRequest;request.open("GET",url),request.onreadystatechange=function(){4===request.readyState&&200===request.status&&(response=window.JSON?JSON.parse(request.responseText):eval("("+request.responseText+")"),cb(response))},request.send()},L.UtfGrid=L.Class.extend({includes:L.Mixin.Events,options:{subdomains:"abc",minZoom:0,maxZoom:18,tileSize:256,resolution:4,useJsonP:!0,pointerCursor:!0},_mouseOn:null,initialize:function(a,b){L.Util.setOptions(this,b),this._url=a,this._cache={};for(var c=0;window["lu"+c];)c++;this._windowKey="lu"+c,window[this._windowKey]={};var d=this.options.subdomains;"string"==typeof this.options.subdomains&&(this.options.subdomains=d.split(""))},onAdd:function(a){this._map=a,this._container=this._map._container,this._update();var b=this._map.getZoom();b>this.options.maxZoom||b<this.options.minZoom||(a.on("click",this._click,this),a.on("mousemove",this._move,this),a.on("moveend",this._update,this))},onRemove:function(){var a=this._map;a.off("click",this._click,this),a.off("mousemove",this._move,this),a.off("moveend",this._update,this),this.options.pointerCursor&&(this._container.style.cursor="")},_click:function(a){this.fire("click",this._objectForEvent(a))},_move:function(a){var b=this._objectForEvent(a);b.data!==this._mouseOn?(this._mouseOn&&(this.fire("mouseout",{latlng:a.latlng,data:this._mouseOn}),this.options.pointerCursor&&(this._container.style.cursor="")),b.data&&(this.fire("mouseover",b),this.options.pointerCursor&&(this._container.style.cursor="pointer")),this._mouseOn=b.data):b.data&&this.fire("mousemove",b)},_objectForEvent:function(a){var b=this._map,c=b.project(a.latlng),d=this.options.tileSize,e=this.options.resolution,f=Math.floor(c.x/d),g=Math.floor(c.y/d),h=Math.floor((c.x-f*d)/e),i=Math.floor((c.y-g*d)/e),j=b.options.crs.scale(b.getZoom())/d;f=(f+j)%j,g=(g+j)%j;var k=this._cache[b.getZoom()+"_"+f+"_"+g];if(!k||!k.grid)return{latlng:a.latlng,data:null};var l=this._utfDecode(k.grid[i].charCodeAt(h)),m=k.keys[l],n=k.data[m];return k.data.hasOwnProperty(m)||(n=null),{latlng:a.latlng,data:n}},_update:function(){var a=this._map.getPixelBounds(),b=this._map.getZoom(),c=this.options.tileSize;if(!(b>this.options.maxZoom||b<this.options.minZoom))for(var d=new L.Point(Math.floor(a.min.x/c),Math.floor(a.min.y/c)),e=new L.Point(Math.floor(a.max.x/c),Math.floor(a.max.y/c)),f=this._map.options.crs.scale(b)/c,g=d.x;g<=e.x;g++)for(var h=d.y;h<=e.y;h++){var i=(g+f)%f,j=(h+f)%f,k=b+"_"+i+"_"+j;this._cache.hasOwnProperty(k)||(this._cache[k]=null,this.options.useJsonP?this._loadTileP(b,i,j):this._loadTile(b,i,j))}},_loadTileP:function(a,b,c){var d=document.getElementsByTagName("head")[0],e=a+"_"+b+"_"+c,f="lu_"+e,g=this._windowKey,h=this,i=L.Util.template(this._url,L.Util.extend({s:L.TileLayer.prototype._getSubdomain.call(this,{x:b,y:c}),z:a,x:b,y:c,cb:g+"."+f},this.options)),j=document.createElement("script");j.setAttribute("type","text/javascript"),j.setAttribute("src",i),window[g][f]=function(a){h._cache[e]=a,delete window[g][f],d.removeChild(j)},d.appendChild(j)},_loadTile:function(a,b,c){var d=L.Util.template(this._url,L.Util.extend({s:L.TileLayer.prototype._getSubdomain.call(this,{x:b,y:c}),z:a,x:b,y:c},this.options)),e=a+"_"+b+"_"+c,f=this;L.Util.ajax(d,function(a){f._cache[e]=a})},_utfDecode:function(a){return a>=93&&a--,a>=35&&a--,a-32}}),L.utfGrid=function(a,b){return new L.UtfGrid(a,b)},define("leafletUTFGrid",function(){}),define("leaflet",[],function(){return window.L}),function(a,b){if("undefined"!=typeof module&&module.exports&&"function"==typeof require)module.exports=b(require("leaflet"));else if("function"==typeof define&&define.amd)define("mpMaps",["leaflet"],b);else{if(!a.MP||!a.Leaflet)throw new Error("Could not find dependencies for MinnPost Styles Maps.");a.MP=a.MP||{},a.MP.maps=b(a.Leaflet)}}("undefined"!=typeof window?window:this,function(a){var b={};return b.minneapolisPoint=a.latLng(44.983333998267824,-93.26667000248563),b.stPaulPoint=a.latLng(44.95370289870105,-93.08995780069381),b.minnesotaPoint=a.latLng(46.518286790004616,-94.55406386114191),b.mapboxSatelliteStreets="minnpost.map-95lgm5jf",b.mapboxStreetsDarkLabels="minnpost.map-4v6echxm",b.mapboxStreetsLightLabels="minnpost.map-wi88b700",b.mapboxTerrainLight="minnpost.map-vhjzpwel",b.mapboxTerrainDark="minnpost.map-dhba3e3l",b.mapOptions={scrollWheelZoom:!1,trackResize:!0},b.mapStyle={stroke:!0,color:"#2DA51D",weight:1.5,opacity:.9,fill:!0,fillColor:"#2DA51D",fillOpacity:.2},b.mapboxAttribution='Some map imagery provided by <a href="https://www.mapbox.com/about/maps/" target="_blank">Mapbox</a>.',b.openstreetmapAttribution='Some map data provided by &copy; <a href="http://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors.',b.makeLeafletMap=function(c,d,e){d=d||b.mapboxStreetsLightLabels,e=e||b.minneapolisPoint;var f=new a.Map(c,b.mapOptions),g=new a.tileLayer("//{s}.tiles.mapbox.com/v3/"+d+"/{z}/{x}/{y}.png");return f.addLayer(g),f.setView(e,8),f.removeControl(f.attributionControl),f},b.makeMakiIcon=function(b,c,d){b=b||null,d=d||"094C86",c=c||"m";var e="https://api.tiles.mapbox.com/v3/marker/",f={s:{iconSize:[20,50],popupAnchor:[0,-20]},m:{iconSize:[30,70],popupAnchor:[0,-30]},l:{iconSize:[36,90],popupAnchor:[0,-40]}};return e=e+"pin-"+c+(null===b?"":"-"+b)+"+"+d+".png",new a.Icon(a.extend(f[c],{iconUrl:e,shadowAnchor:null,shadowSize:null,shadowUrl:null,className:"maki-marker"}))},b.TooltipControl=a.Control.extend({options:{position:"topright"},initialize:function(){},update:function(a){this._contentWrapper.innerHTML=a,this.show()},show:function(){this._container.style.display="block"},hide:function(){this._container.style.display="none"},onAdd:function(){return this._container=a.DomUtil.create("div","map-tooltip"),this._contentWrapper=a.DomUtil.create("div","map-tooltip-content"),this._container.appendChild(this._contentWrapper),this.hide(),this._container},onRemove:function(){}}),b}),define("helpers",["jquery","underscore"],function(a,b){var c={};return c.overrideBackboneAJAX=function(){Backbone.ajax=function(){var a=arguments;return a[0].dataTypeForce!==!0&&(a[0].dataType="jsonp",a[0].jsonpCallback="mpServerSideCachingHelper"+b.hash(a[0].url)),Backbone.$.ajax.apply(Backbone.$,a)}},c.isMSIE=function(){var a=/(msie) ([\w.]+)/i.exec(navigator.userAgent);return a?parseInt(a[2],10):!1},c.jsonpRequest=function(c,d){return options.dataType="jsonp",options.jsonpCallback="mpServerSideCachingHelper"+b.hash(options.url),d.remoteProxy&&(options.url=options.url+"&callback=mpServerSideCachingHelper",options.url=d.remoteProxy+encodeURIComponent(options.url),options.cache=!0),a.ajax.apply(a,[options])},c.getLocalData=function(d,e){var f=!1,g=[];return d=b.isArray(d)?d:[d],e&&e.paths&&0===e.paths.data.indexOf("http")&&(f=!0),b.each(d,function(b){var d;d=f?c.jsonpRequest({url:proxyPrefix+encodeURI(e.paths.data+b)},e):a.getJSON(e.paths.data+b),g.push(d)}),a.when.apply(a,g)},c.parseQueryString=function(){var a={},c=function(a){return decodeURIComponent(a.replace(/\+/g," "))},d=location.search.substring(1),e=d.split("&");return b.each(e,function(b){var d=b.split("=");d.length>1&&(a[c(d[0])]=c(d[1]))}),a},c}),define("text!templates/application.underscore",[],function(){return'<div class="application-container">\n  <div class="message-container"></div>\n\n  <div class="content-container">\n\n    <div class="component-label">Hennepin County parcels</div>\n\n    <div class="caption">The map below shows the estimated market value of most all the parcels in Hennepin County.  Hover over (or tap on a mobile device) to see some more information about the parcel.</div>\n\n    <div class="legend caption">\n      <ul>\n        <% _.each(legend, function(l, li) { %>\n          <li class="inline-block"><span class="inline-block" style="background-color: <%= li %>"></span> <%= l %></li>\n        <% }) %>\n      </ul>\n    </div>\n\n    <div class="map" id="h-county-parcels">\n    </div>\n\n  </div>\n\n  <div class="footnote-container">\n    <div class="footnote">\n      <p>Some code, techniques, and data on <a href="https://github.com/minnpost/minnpost-hennepin-county-parcels" target="_blank">Github</a>.  Some map data © OpenStreetMap contributors; licensed under the <a href="http://www.openstreetmap.org/copyright" target="_blank">Open Data Commons Open Database License</a>.  Some map design © MapBox; licensed according to the <a href="http://mapbox.com/tos/" target="_blank">MapBox Terms of Service</a>.</p>\n\n    </div>\n  </div>\n</div>\n'}),define("text!templates/map-tooltip.underscore",[],function(){return"<% if (!data.MKT_VAL_TO) { %>\n  <div>There is no estimated market value on this parcel.</div>\n<% } else { %>\n\n  <div>\n    Estimated market value is <strong><%= '$' + format.number(data.MKT_VAL_TO, 0) %></strong>.\n    <% if (data.EST_BLDG_M || data.EST_LAND_M) { %>\n      This is made up from a building value of <%= '$' + format.number(data.EST_BLDG_M || 0, 0) %> and a land value of <%= '$' + format.number(data.EST_LAND_M || 0, 0) %>.\n    <% } %>\n\n    <% if (data.BUILD_YR) { %>\n      Approximately built in <strong><%= data.BUILD_YR %></strong>.\n    <% } %>\n\n    <% if (data.HMSTD_CD1_ || data.PROPERTY_T) { %>\n      This parcel is classified as <em><%= data.PROPERTY_T.toLowerCase() %></em>, <em><%= data.HMSTD_CD1_.toLowerCase() %></em>.\n    <% } %>\n  </div>\n\n<% } %>\n"}),define("minnpost-hennepin-county-parcels",["jquery","underscore","leafletUTFGrid","mpConfig","mpFormatters","mpMaps","helpers","text!templates/application.underscore","text!templates/map-tooltip.underscore"],function(a,b,c,d,e,f,g,h,i){var j=function(c){this.options=b.extend(this.defaultOptions,c),this.el=this.options.el,this.$el=a(this.el),this.$=function(a){return this.$el.find(a)},this.$content=this.$el.find(".content-container"),this.loadApp()};return b.extend(j.prototype,{start:function(){var c=this;this.$el.html(b.template(h,{legend:{"#F1F1F1":"$0 or no data.","#543005":"$0 - $100k","#8c510a":"$100k - $250k","#bf812d":"$250k - $500","#dfc27d":"$500 - $1M","#c7eae5":"$1M - $2M","#80cdc1":"$2M - $5M","#35978f":"$5M - $20M","#01665e":"$20M - $100M","#003c30":"above $100M"}})),this.tooltipTemplate=b.template(i),a.getJSON(this.options.tilestream_base+this.options.tilestream_map+".json?callback=?",function(a){c.tilejson=a,c.makeMap(),c.handleEvents()})},makeMap:function(){var a=this;this.map=new L.map("h-county-parcels",{minZoom:this.tilejson.minzoom,maxZoom:this.tilejson.maxzoom,scrollWheelZoom:!1,trackResize:!0}).setView([this.tilejson.center[1],this.tilejson.center[0]],this.tilejson.center[2]),this.map.removeControl(this.map.attributionControl),this.tooltip=new f.TooltipControl,this.map.addControl(this.tooltip),L.tileLayer(this.options.tilestream_base+this.options.tilestream_map+"/{z}/{x}/{y}.png",{}).addTo(this.map),this.grid=new L.UtfGrid(this.options.tilestream_base+this.options.tilestream_map+"/{z}/{x}/{y}.grid.json?callback={cb}",{useJsonP:!0}),this.grid.on("mouseover",function(b){b.data=a.parseParcelData(b.data),a.tooltip.update(a.tooltipTemplate({format:e,data:b.data}))}),this.grid.on("mouseout",function(){a.tooltip.hide()}),this.map.addLayer(this.grid),L.tileLayer(this.options.mapbox_base+"minnpost.map-dotjndlk/{z}/{x}/{y}.png",{zIndex:100,minZoom:12}).addTo(this.map),L.tileLayer(this.options.mapbox_base+"minnpost.map-vhjzpwel/{z}/{x}/{y}.png",{zIndex:-100}).addTo(this.map),b.delay(function(){a.map.invalidateSize()},750)},handleEvents:function(){var c=this,d={harriet:{loc:[44.92236863873383,-93.30546547367703],zoom:14},ids:{loc:[44.97611437647188,-93.27250648930203],zoom:15}};this.$el.find(".location-link").on("click",function(e){e.preventDefault();var f=a(this).data("location");b.isObject(d[f])&&c.map.setView(d[f].loc,d[f].zoom)})},parseParcelData:function(a){return a.BUILD_YR="0000"==a.BUILD_YR||a.BUILD_YR<1?null:a.BUILD_YR,a},defaultOptions:{projectName:"minnpost-hennepin-county-parcels",remoteProxy:null,el:".minnpost-hennepin-county-parcels-container",tilestream_base:"//ec2-54-82-59-19.compute-1.amazonaws.com:9003/v2/",tilestream_map:"hennepin-parcels",mapbox_base:"//{s}.tiles.mapbox.com/v3/",availablePaths:{local:{css:[".tmp/css/main.css"],images:"images/",data:"data/"},build:{css:["//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css","dist/minnpost-hennepin-county-parcels.libs.min.css","dist/minnpost-hennepin-county-parcels.latest.min.css"],ie:["dist/minnpost-hennepin-county-parcels.libs.min.ie.css","dist/minnpost-hennepin-county-parcels.latest.min.ie.css"],images:"dist/images/",data:"dist/data/"},deploy:{css:["//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css","https://s3.amazonaws.com/data.minnpost/projects/minnpost-hennepin-county-parcels/minnpost-hennepin-county-parcels.libs.min.css","https://s3.amazonaws.com/data.minnpost/projects/minnpost-hennepin-county-parcels/minnpost-hennepin-county-parcels.latest.min.css"],ie:["https://s3.amazonaws.com/data.minnpost/projects/minnpost-hennepin-county-parcels/minnpost-hennepin-county-parcels.libs.min.ie.css","https://s3.amazonaws.com/data.minnpost/projects/minnpost-hennepin-county-parcels/minnpost-hennepin-county-parcels.latest.min.ie.css"],images:"https://s3.amazonaws.com/data.minnpost/projects/minnpost-hennepin-county-parcels/images/",data:"https://s3.amazonaws.com/data.minnpost/projects/minnpost-hennepin-county-parcels/data/"}}},loadApp:function(){this.determinePaths(),this.getLocalAssests(function(a){this.renderAssests(a),this.start()})},determinePaths:function(){var a;this.options.deployment="deploy",-1!==window.location.host.indexOf("localhost")&&(this.options.deployment="local",a=g.parseQueryString(),b.isObject(a)&&b.isString(a.mpDeployment)&&(this.options.deployment=a.mpDeployment)),this.options.paths=this.options.availablePaths[this.options.deployment]},getLocalAssests:function(b){var c=this;"local"===this.options.deployment?a.getJSON("bower.json",function(a){b.apply(c,[a.dependencyMap])}):b.apply(this,[])},renderAssests:function(c){var d=g.isMSIE()&&g.isMSIE()<=8;b.isObject(c)&&b.each(c,function(c){c.css&&b.each(c.css,function(b){b=b.match(/^(http|\/\/)/)?b:"bower_components/"+b+".css",a("head").append('<link rel="stylesheet" href="'+b+'" type="text/css" />')}),c.ie&&d&&b.each(c.ie,function(b){b=b.match(/^(http|\/\/)/)?b:"bower_components/"+b+".css",a("head").append('<link rel="stylesheet" href="'+b+'" type="text/css" />')})}),b.each(this.options.paths.css,function(b){a("head").append('<link rel="stylesheet" href="'+b+'" type="text/css" />')}),d&&b.each(this.options.paths.ie,function(b){a("head").append('<link rel="stylesheet" href="'+b+'" type="text/css" />')}),this.$el.addClass("processed")}}),j}),require(["jquery","minnpost-hennepin-county-parcels"],function(a,b){a(document).ready(function(){new b})});